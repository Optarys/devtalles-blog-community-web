<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  </head>
  <body style="background:#000; color:#000"> <!-- invisible -->
    <script type="application/json" id="boot">
      {JSON.stringify({
        user: user ?? null,
        next,
        // fuerza ok=true: el cliente ya no hará rama de error
        ok: true
      })}
    </script>

    <script is:inline>
      (() => {
        try {
          const bootEl = document.getElementById("boot");
          const BOOT = bootEl ? JSON.parse(bootEl.textContent || "{}") : {};

          // 1) user desde cookie temporal o jwt (si vino)
          let u = null;
          if (BOOT?.user) {
            u = {
              email: BOOT.user.email ?? "",
              username: BOOT.user.username ?? BOOT.user.email ?? "",
              roles: Array.isArray(BOOT.user.roles) ? BOOT.user.roles : []
            };
          }

          // 2) si aún no hay user, crea uno mínimo y continúa
          if (!u) {
            u = { email: "", username: "usuario", roles: [] };
          }

          // 3) persiste y limpia cookie temporal si existe
          localStorage.setItem("dt:user", JSON.stringify(u));
          // intenta limpiar cookie auxiliar si la había
          document.cookie = "dt_user=; Max-Age=0; Path=/; SameSite=Lax";

          // 4) redirige SIEMPRE al destino
          location.replace(BOOT.next || "/");
        } catch {
          // incluso si algo raro pasa, no regreses al login: vete al home
          location.replace("/");
        }
      })();
    </script>
  </body>
</html>
