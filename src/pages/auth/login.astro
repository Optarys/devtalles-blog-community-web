---
import { RootLayout } from "@/layouts";
import { Button, InputField } from "@/components/ui";
import { FaDiscord, FaGithub, FaGoogle } from "react-icons/fa";

const API_URL = import.meta.env.PUBLIC_API_URL;
const FRONT_BASE = (
  import.meta.env.PUBLIC_FRONTEND_URL ?? Astro.url.origin
).replace(/\/+$/, "");
const REDIRECT = encodeURIComponent(`${FRONT_BASE}/auth/callback`);

const error = Astro.url.searchParams.get("error");
const ok = Astro.url.searchParams.get("ok");
---

<RootLayout title="Iniciar sesión">
  <section class="grid min-h-[100svh] w-full grid-cols-1 md:grid-cols-2">
    <!-- Columna izquierda -->
    <div
      class="relative flex items-center justify-center p-8 md:p-12 overflow-hidden"
    >
      <!-- Asegúrate que esta imagen exista; si no, usa /assets/img/devtalles.jpg -->
      <div
        class="absolute inset-0 bg-[url('/assets/img/devtalles.jpg')] bg-cover bg-center"
        aria-hidden="true"
      >
      </div>
      <div class="absolute inset-0 bg-black/55" aria-hidden="true"></div>

      <div class="relative z-10 max-w-md text-center md:text-left">
        <img
          src="/assets/png/LOGO%20B.png"
          alt="DevTalles"
          class="mx-auto h-10 w-auto md:mx-0"
        />
        <h1 class="mt-6 text-3xl font-extrabold text-[var(--color-title)]">
          Bienvenido a la comunidad DevTalles
        </h1>
        <p class="mt-3 text-[var(--color-text)]/80">
          Artículos y recursos para crecer como desarrollador.
        </p>
      </div>
    </div>

    <!-- Columna derecha -->
    <div class="flex items-center justify-center p-8 md:p-12">
      <div
        class="w-full max-w-md rounded-2xl border border-white/10 bg-[var(--color-contrast)]/60 p-8 shadow-xl backdrop-blur-sm"
      >
        <h2 class="mb-1 text-2xl font-bold text-[var(--color-title)]">
          Inicia sesión
        </h2>
        <p class="mb-6 text-sm text-[var(--color-text)]/70">
          Usa tu correo/usuario y contraseña.
        </p>

        {
          ok === "signup_success" && (
            <div class="mb-4 rounded-lg border border-emerald-500/30 bg-emerald-500/10 p-3 text-sm text-emerald-200">
              ¡Cuenta creada con éxito! Ahora inicia sesión.
            </div>
          )
        }
        {
          error && (
            <div class="mb-4 rounded-lg border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-200">
              {error}
            </div>
          )
        }

        <!-- OJO: action fijo a /api/auth/login y next -> /admin -->
        <form class="space-y-5" method="post" action="/api/auth/login">
          <input type="hidden" name="next" value="/admin" />

          <InputField
            id="identifier"
            name="identifier"
            type="text"
            label="Correo o usuario"
            placeholder="email o usuario"
            required
          />
          <InputField
            id="password"
            name="password"
            type="password"
            label="Contraseña"
            placeholder="••••••••"
            required
          />

          <!-- Para descartar problemas del Button personalizado, puedes probar con un <button> nativo -->
          <button
            type="submit"
            class="w-full rounded-lg px-4 py-2 bg-[var(--color-accent)] text-[var(--color-accent-foreground)]"
          >
            Iniciar sesión
          </button>
        </form>

        <div class="my-6 flex items-center">
          <span class="h-px flex-1 bg-white/10"></span>
          <span class="mx-3 text-xs text-[var(--color-text)]/60">o</span>
          <span class="h-px flex-1 bg-white/10"></span>
        </div>

        <div class="space-y-3">
          <Button
            href={`${API_URL}/auth/oauth2/redirect?provider=discord&redirect_uri=${REDIRECT}`}
            variant="outline"
            fullWidth
            size="md"
          >
            <FaDiscord className="text-lg" />
            <span class="ml-2">Continuar con Discord</span>
          </Button>
          <Button
            href={`${API_URL}/auth/oauth2/redirect?provider=google&redirect_uri=${REDIRECT}`}
            variant="outline"
            fullWidth
            size="md"
          >
            <FaGoogle className="text-lg" />
            <span class="ml-2">Continuar con Google</span>
          </Button>
          <Button
            href={`${API_URL}/auth/oauth2/redirect?provider=github&redirect_uri=${REDIRECT}`}
            variant="outline"
            fullWidth
            size="md"
          >
            <FaGithub className="text-lg" />
            <span class="ml-2">Continuar con GitHub</span>
          </Button>
        </div>

        <p class="mt-6 text-center text-sm text-[var(--color-text)]/70">
          ¿No tienes cuenta? <a
            href="/auth/signup"
            class="text-[var(--color-accent)] hover:underline">Regístrate</a
          >
        </p>
      </div>
    </div>
  </section>
</RootLayout>
