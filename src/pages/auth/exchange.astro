---
const API_BASE = (import.meta.env.PUBLIC_API_URL ?? "").replace(/\/+$/, "");
const url = new URL(Astro.request.url);
const next = url.searchParams.get("next") ?? "/";
---

<!doctype html>
<html>
  <head><meta charset="utf-8" /><title>Intercambiando código…</title></head>
  <body>
    <p>Procesando autenticación…</p>

    <script
      is:inline
      data-api={API_BASE}
      data-next={next}
    >
      (async () => {
        const s = document.currentScript;
        const API  = s?.dataset.api  || "";
        const NEXT = s?.dataset.next || "/";

        try {
          const sp = new URLSearchParams(location.search);
          const code = sp.get("code");
          if (!code) return location.replace("/auth/login?error=falta_code");

          const res = await fetch(`${API}/auth/oauth2/exchange?code=${encodeURIComponent(code)}`, {
            credentials: "include",
            headers: { Accept: "application/json" },
          });
          if (!res.ok) throw new Error("exchange_failed");

          location.replace(`/auth/callback?next=${encodeURIComponent(NEXT)}`);
        } catch (e) {
          location.replace("/auth/login?error=" + encodeURIComponent(e?.message || "Error en exchange"));
        }
      })();
    </script>
  </body>
</html>
