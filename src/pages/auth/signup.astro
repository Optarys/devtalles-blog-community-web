---
import { RootLayout } from "@/layouts";
import { Button, InputField } from "@/components/ui";
import { FaDiscord, FaGithub, FaGoogle } from "react-icons/fa";

const API_URL = import.meta.env.PUBLIC_API_URL;

// FRONT para redirect_uri, sin slashes finales
const FRONT_BASE = (
  import.meta.env.PUBLIC_FRONTEND_URL ?? Astro.url.origin
).replace(/\/+$/, "");
const REDIRECT = encodeURIComponent(`${FRONT_BASE}/auth/callback`);

// Respeta base de astro.config
const BASE = (import.meta.env.BASE_URL ?? "/").replace(/\/+$/, "");
const ACTION = `${BASE}/auth/register`;

const error = Astro.url.searchParams.get("error");
---

<RootLayout title="Crear cuenta">
  <section class="grid min-h-[100svh] w-full grid-cols-1 md:grid-cols-2">
    <!-- Columna izquierda -->
    <div
      class="relative flex items-center justify-center p-8 md:p-12 overflow-hidden"
    >
      <div
        class="absolute inset-0 bg-[url('/assets/img/devtalles.jpg')] bg-cover bg-center"
        aria-hidden="true"
      >
      </div>
      <div class="absolute inset-0 bg-black/55" aria-hidden="true"></div>

      <div class="relative z-10 max-w-md text-center md:text-left">
        <img
          src="/assets/png/LOGO%20B.png"
          alt="DevTalles"
          class="mx-auto h-10 w-auto md:mx-0"
          loading="lazy"
          decoding="async"
        />
        <h1 class="mt-6 text-3xl font-extrabold text-[var(--color-title)]">
          Únete a la comunidad DevTalles
        </h1>
        <p class="mt-3 text-[var(--color-text)]/80">
          Crea tu cuenta para guardar favoritos, comentar y recibir novedades.
        </p>

        <ul class="mt-6 space-y-3 text-sm text-[var(--color-text)]/90">
          <li class="flex items-start gap-3">
            <span
              class="mt-1 inline-block h-2 w-2 rounded-full bg-[var(--color-accent)]"
            ></span>
            <span>Tutoriales y artículos curados por la comunidad.</span>
          </li>
          <li class="flex items-start gap-3">
            <span
              class="mt-1 inline-block h-2 w-2 rounded-full bg-[var(--color-accent)]"
            ></span>
            <span>Mejores prácticas de frontend, backend y arquitectura.</span>
          </li>
          <li class="flex items-start gap-3">
            <span
              class="mt-1 inline-block h-2 w-2 rounded-full bg-[var(--color-accent)]"
            ></span>
            <span>Participa con Debi en retos y eventos.</span>
          </li>
        </ul>

        <a
          href="https://cursos.devtalles.com/"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-8 inline-block rounded-lg border border-[var(--color-accent)] px-5 py-2 font-semibold
                 text-[var(--color-accent)] transition hover:bg-[var(--color-accent)]
                 hover:text-[var(--color-accent-foreground)]"
        >
          Conocer más
        </a>
      </div>
    </div>

    <!-- Columna derecha -->
    <div class="flex items-center justify-center p-8 md:p-12">
      <div
        class="w-full max-w-md rounded-2xl border border-white/10 bg-[var(--color-contrast)]/60 p-8 shadow-xl backdrop-blur-sm"
      >
        <h2 class="mb-1 text-2xl font-bold text-[var(--color-title)]">
          Crea tu cuenta
        </h2>
        <p class="mb-6 text-sm text-[var(--color-text)]/70">
          Completa los datos o usa tu cuenta de Discord.
        </p>

        {
          error && (
            <div class="mb-4 rounded-lg border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-200">
              {error}
            </div>
          )
        }

        <form method="post" action={ACTION} class="space-y-5">
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <InputField
              id="firstName"
              name="firstName"
              type="text"
              label="Nombre"
              placeholder="Kevin"
              required
              autoComplete="given-name"
            />
            <InputField
              id="lastName"
              name="lastName"
              type="text"
              label="Apellido"
              placeholder="Ortiz"
              required
              autoComplete="family-name"
            />
          </div>

          <InputField
            id="username"
            name="username"
            type="text"
            label="Usuario"
            placeholder="kevin123"
            required
            autoComplete="username"
          />
          <InputField
            id="email"
            name="email"
            type="email"
            label="Correo electrónico"
            placeholder="user@example.com"
            required
            autoComplete="email"
          />
          <InputField
            id="password"
            name="password"
            type="password"
            label="Contraseña"
            placeholder="Mínimo 8 caracteres"
            required
            autoComplete="new-password"
          />
          <InputField
            id="confirm"
            name="confirm"
            type="password"
            label="Confirmar contraseña"
            placeholder="Repite tu contraseña"
            required
            autoComplete="new-password"
          />

          <label class="flex items-start gap-3 text-sm">
            <input type="checkbox" name="terms" required class="mt-1" />
            <span class="text-[var(--color-text)]/80">
              Acepto los
              <a
                href="/legal/terminos"
                class="text-[var(--color-accent)] hover:underline"
                >Términos y Condiciones</a
              >
              y la
              <a
                href="/legal/privacidad"
                class="text-[var(--color-accent)] hover:underline"
                >Política de Privacidad</a
              >.
            </span>
          </label>

          <button
            type="submit"
            class="w-full rounded-lg px-4 py-2 bg-[var(--color-accent)] text-[var(--color-accent-foreground)]"
          >
            Crear cuenta
          </button>
        </form>

        <div class="my-6 flex items-center">
          <span class="h-px flex-1 bg-white/10"></span>
          <span class="mx-3 text-xs text-[var(--color-text)]/60">o</span>
          <span class="h-px flex-1 bg-white/10"></span>
        </div>

        <div class="space-y-3">
          <Button
            href={`${API_URL}/auth/oauth2/redirect?provider=discord&redirect_uri=${REDIRECT}`}
            variant="outline"
            fullWidth
            size="md"
          >
            <FaDiscord className="text-lg" /><span class="ml-2"
              >Registrarme con Discord</span
            >
          </Button>
          <Button
            href={`${API_URL}/auth/oauth2/redirect?provider=google&redirect_uri=${REDIRECT}`}
            variant="outline"
            fullWidth
            size="md"
          >
            <FaGoogle className="text-lg" /><span class="ml-2"
              >Registrarme con Google</span
            >
          </Button>
          <Button
            href={`${API_URL}/auth/oauth2/redirect?provider=github&redirect_uri=${REDIRECT}`}
            variant="outline"
            fullWidth
            size="md"
          >
            <FaGithub className="text-lg" /><span class="ml-2"
              >Registrarme con GitHub</span
            >
          </Button>
        </div>

        <p class="mt-6 text-center text-sm text-[var(--color-text)]/70">
          ¿Ya tienes cuenta?
          <a
            href="/auth/login"
            class="font-medium text-[var(--color-accent)] hover:underline"
            >Inicia sesión</a
          >
        </p>
      </div>
    </div>
  </section>
</RootLayout>
